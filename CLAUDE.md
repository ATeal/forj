# forj

REPL-driven LLM development for Clojure.

## Project Overview

forj provides seamless Claude Code integration for Clojure projects:
- **forj-mcp**: MCP server for REPL connectivity ✅
- **forj-hooks**: Claude Code hooks for context injection ✅
- **forj-skill**: `/clj-repl` skill for REPL management ✅
- **clj-init**: `/clj-init` skill for project scaffolding ✅

## Philosophy: Why REPL + LLM

**The Training Data Paradox**: Conventional wisdom says "use Python/TypeScript because LLMs have seen more of it." But if the agent has a REPL, training data volume matters less - wrong syntax gets immediate feedback, the agent self-corrects in real-time.

**REPL vs Test Validation**:
- Test-based loops validate at the test/build level
- REPL validation happens at the expression level
- You catch mistakes 10x faster because you're not waiting for a full test suite

**Lisa Loop's Fresh Instance Advantage**:
| Layer | Persists Across Iterations? |
|-------|----------------------------|
| LISA_PLAN.edn | ✅ Yes - progress tracking |
| Git/Files | ✅ Yes - code changes |
| REPL state | ✅ Yes - loaded namespaces |
| Claude context | ❌ No - fresh each time |

This prevents context bloat and hallucination from stale memory.

## Quick Start

```bash
git clone https://github.com/your-org/forj.git
cd forj
bb install    # Installs MCP, hooks, and skill to ~/.claude/
```

## Development

```bash
bb nrepl                  # Start REPL for forj development
bb mcp:dev                # Run MCP server in dev mode
bb test                   # Run all tests
bb logs                   # View forj logs
```

## MCP Tools Available

| Tool | Description | Like |
|------|-------------|------|
| `repl_eval` | Evaluate Clojure code in nREPL | Direct eval |
| `reload_namespace` | Reload a namespace from file | `,ef` |
| `eval_at` | Evaluate form at specific line (root/inner) | `,er` / `,ee` |
| `eval_comment_block` | Evaluate all forms in a comment block | `,eb` |
| `doc_symbol` | Look up documentation for a symbol | `K` |
| `discover_repls` | Find running nREPL servers | - |
| `analyze_project` | Get project configuration info | - |
| `run_tests` | Run project tests (auto-detects runner) | - |
| `validate_changed_files` | Reload + eval comment blocks in changed files | Lisa Loop |
| `validate_project` | Validate project setup (deps, bb.edn, npm, Java) | - |
| `scaffold_project` | Create new project from composable modules | - |
| `track_process` | Track a background process for cleanup | - |
| `stop_project` | Stop all tracked processes for a project | `/clj-repl stop` |
| `list_tracked_processes` | List what's been tracked | - |

## Architecture

Babashka-based, shells to `clj-nrepl-eval` for REPL operations.
Uses edamame for Clojure parsing with location metadata.
Path-based REPL routing auto-selects clj/cljs/bb REPLs.

## Skills

| Skill | Description |
|-------|-------------|
| `/clj-repl` | Start or connect to Clojure/ClojureScript/Babashka nREPL |
| `/clj-init` | Create a new Clojure project with interactive configuration |
| `/lisa-loop` | REPL-driven autonomous development loops |

### /clj-init Project Types

- **Script/CLI** (bb) - Babashka script with tasks
- **Library** (clj) - deps.edn library with tests
- **API Server** (api) - Ring/Reitit backend
- **Full-stack** (fullstack) - Clojure + ClojureScript + shadow-cljs
- **Mobile** (mobile) - Expo + ClojureScript (Reagent/Re-frame)

### /lisa-loop - Autonomous Development

Start an autonomous development loop:
```
/lisa-loop "Build a REST API for users" --max-iterations 20
```

The orchestrator spawns fresh Claude instances per checkpoint, with REPL-based validation guidance.

## Files

- `packages/forj-mcp/` - MCP server implementation
- `packages/forj-hooks/` - Claude Code hooks
- `packages/forj-skill/` - Skill definitions (`/clj-repl`, `/clj-init`, `/lisa-loop`)
- `bin/forj-mcp` - Launcher script for MCP server
- `examples/` - Example configs for installation

**Never commit:** `LISA_PLAN.edn` is runtime state generated by `/lisa-loop`. It is in `.gitignore` and should not be staged or committed.

## MCP Configuration

**IMPORTANT**: Claude Code MCP servers must be configured in `~/.claude.json` (user scope), NOT `~/.claude/mcp.json`.

The `bb install` task uses `claude mcp add --scope user` to register forj correctly.

To manually add/remove:
```bash
claude mcp add forj /path/to/forj/bin/forj-mcp --scope user
claude mcp remove forj --scope user
```

Debug logs: `~/.cache/claude-cli-nodejs/<project-path>/mcp-logs-forj/*.jsonl`

## Current Status

### Completed
- Phase 1: MCP server with core tools
- Phase 2: SessionStart + UserPromptSubmit hooks
- Phase 3: Path-based REPL routing (clj/cljs/bb auto-selection)
- Surgical eval (`eval_at` with root/inner scope)
- Rich comment block eval (`eval_comment_block`)
- Doc lookup (`doc_symbol`)
- Test runner (`run_tests`)
- Auto port discovery
- Structured logging to `~/.forj/logs/`
- LSP detection and context injection
- Installation tasks (`bb install`)
- Full test suite (34 tests, 273 assertions)

### Completed Recently
- `/lisa-loop` orchestrator-based autonomous development loop
- `/clj-init` skill with interactive project scaffolding
- Composable module system for scaffolding (replaces templates)
- `scaffold_project` MCP tool with config merging
- Version management via versions.edn (single source of truth)
- Process tracking (`track_process`, `stop_project`, `list_tracked_processes`)
- Conditional version resolution fix (shadow-cljs 2.x vs 3.x based on Java version)
