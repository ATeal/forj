{:min-bb-version "1.3.190"

 :paths ["packages/forj-mcp/src"
         "packages/forj-hooks/src"
         "packages/clj-init/src"]

 :deps {cheshire/cheshire {:mvn/version "5.13.0"}}

 :tasks
 {:requires ([babashka.fs :as fs]
             [cheshire.core :as json]
             [clojure.string :as str])

  dev
  {:doc "Start development environment"
   :task (println "forj dev environment - use bb mcp:dev to test MCP server")}

  test
  {:doc "Run all tests"
   :task (do
           (run 'test:mcp)
           (run 'test:hooks)
           (run 'test:skill))}

  test:mcp
  {:doc "Test MCP server"
   :task (shell "bb" "-cp" "packages/forj-mcp/src:packages/forj-hooks/src:packages/forj-mcp/test"
                "-m" "forj.mcp.test-runner")}

  test:hooks
  {:doc "Test hooks"
   :task (shell "bb" "-cp" "packages/forj-mcp/src:packages/forj-hooks/src:packages/forj-hooks/test"
                "-m" "forj.hooks.test-runner")}

  test:skill
  {:doc "Test skill definition"
   :task (shell "bb" "-cp" "packages/forj-skill/test"
                "-m" "forj.skill-test-runner")}

  mcp:dev
  {:doc "Run MCP server in dev mode (for testing)"
   :task (shell "bb" "-cp" "packages/forj-mcp/src:packages/forj-hooks/src" "-m" "forj.mcp.server")}

  mcp:install
  {:doc "Install forj-mcp as bbin script"
   :task (shell "bbin" "install" "." "--as" "forj-mcp" "--main-opts" "['-m' 'forj.mcp.server']")}

  eval
  {:doc "Evaluate Clojure code via forj (usage: bb eval '(+ 1 2)' or bb eval -p 1669 '(+ 1 2)')"
   :requires ([forj.mcp.tools :as tools]
              [cheshire.core :as json])
   :task (let [args *command-line-args*
               [port code] (if (= "-p" (first args))
                             [(parse-long (second args)) (nth args 2)]
                             [nil (first args)])
               result (tools/eval-code {:code code :port port})]
           (if (:success result)
             (println (:value result))
             (do (println "Error:" (:error result))
                 (System/exit 1))))}

  nrepl
  {:doc "Start nREPL server for forj development"
   :task (shell "bb" "--nrepl-server" "1669")}

  logs
  {:doc "View forj logs (tail -f)"
   :task (let [log-dir (str (fs/path (System/getProperty "user.home") ".forj" "logs"))]
           (if (fs/exists? log-dir)
             (shell "tail" "-f" (str (fs/path log-dir "mcp-server.log"))
                    (str (fs/path log-dir "session-start.log")))
             (println "No logs yet. Logs will be written to:" log-dir)))}

  logs:list
  {:doc "List all log files"
   :task (let [log-dir (str (fs/path (System/getProperty "user.home") ".forj" "logs"))]
           (if (fs/exists? log-dir)
             (shell "ls" "-lh" log-dir)
             (println "No logs yet. Logs will be written to:" log-dir)))}

  logs:errors
  {:doc "View error log"
   :task (let [error-log (str (fs/path (System/getProperty "user.home") ".forj" "logs" "errors.log"))]
           (if (fs/exists? error-log)
             (shell "cat" error-log)
             (println "No errors logged yet.")))}

  logs:clear
  {:doc "Clear all logs"
   :task (let [log-dir (str (fs/path (System/getProperty "user.home") ".forj" "logs"))]
           (when (fs/exists? log-dir)
             (doseq [f (fs/glob log-dir "*.log")]
               (fs/delete f))
             (println "Logs cleared.")))}

  ;; Installation tasks
  install
  {:doc "Install forj (MCP server, hooks, and skill)"
   :task (do
           (run 'install:mcp)
           (run 'install:hooks)
           (run 'install:skill)
           (println "\n✓ forj installed! Restart Claude Code to activate."))}

  install:mcp
  {:doc "Install MCP server config to ~/.claude/mcp.json"
   :task (let [forj-path (System/getProperty "user.dir")
               claude-dir (str (fs/path (System/getProperty "user.home") ".claude"))
               mcp-file (str (fs/path claude-dir "mcp.json"))
               existing (when (fs/exists? mcp-file)
                          (json/parse-string (slurp mcp-file) true))
               forj-config {:command (str forj-path "/bin/forj-mcp")
                            :args []}
               new-config (update existing :mcpServers assoc :forj forj-config)]
           (fs/create-dirs claude-dir)
           (spit mcp-file (json/generate-string new-config {:pretty true}))
           (println "✓ MCP config installed to" mcp-file))}

  install:hooks
  {:doc "Install hooks config to ~/.claude/settings.json"
   :task (let [forj-path (System/getProperty "user.dir")
               claude-dir (str (fs/path (System/getProperty "user.home") ".claude"))
               settings-file (str (fs/path claude-dir "settings.json"))
               existing (when (fs/exists? settings-file)
                          (json/parse-string (slurp settings-file) true))
               cp (str forj-path "/packages/forj-mcp/src:" forj-path "/packages/forj-hooks/src")
               hooks-config {:SessionStart [{:hooks [{:type "command"
                                                      :command (str "bb -cp " cp " -m forj.hooks.session-start")}]}]
                             :UserPromptSubmit [{:hooks [{:type "command"
                                                          :command (str "bb -cp " cp " -m forj.hooks.user-prompt")}]}]
                             ;; Paren repair with graceful error handling
                             :PreToolUse [{:matcher "Edit|Write|NotebookEdit"
                                           :hooks [{:type "command"
                                                    :command (str "bb -cp " cp " -m forj.hooks.paren-repair")}]}]
                             ;; Lisa Loop: Stop hook for autonomous development loops
                             :Stop [{:hooks [{:type "command"
                                              :command (str "bb -cp " cp " -m forj.hooks.stop")}]}]}
               new-config (update existing :hooks merge hooks-config)]
           (fs/create-dirs claude-dir)
           (spit settings-file (json/generate-string new-config {:pretty true}))
           (println "✓ Hooks config installed to" settings-file))}

  install:skill
  {:doc "Install forj skills (/clj-repl, /clj-init, /lisa-loop) to ~/.claude/skills/"
   :task (let [forj-path (System/getProperty "user.dir")
               skills-base (str (fs/path (System/getProperty "user.home") ".claude" "skills"))
               ;; Install clj-repl skill
               clj-repl-dir (str (fs/path skills-base "clj-repl"))
               clj-repl-source (str (fs/path forj-path "packages" "forj-skill" "SKILL.md"))
               _ (fs/create-dirs clj-repl-dir)
               _ (fs/copy clj-repl-source (str (fs/path clj-repl-dir "SKILL.md")) {:replace-existing true})
               _ (println "✓ /clj-repl skill installed to" clj-repl-dir)
               ;; Install clj-init skill (SKILL.md + templates)
               clj-init-dir (str (fs/path skills-base "clj-init"))
               clj-init-source (str (fs/path forj-path "packages" "forj-skill" "clj-init"))
               _ (fs/create-dirs clj-init-dir)
               _ (fs/copy (str (fs/path clj-init-source "SKILL.md"))
                          (str (fs/path clj-init-dir "SKILL.md")) {:replace-existing true})
               ;; Copy templates directory
               templates-source (str (fs/path clj-init-source "templates"))
               templates-dest (str (fs/path clj-init-dir "templates"))
               _ (when (fs/exists? templates-dest)
                   (fs/delete-tree templates-dest))
               _ (fs/copy-tree templates-source templates-dest)
               _ (println "✓ /clj-init skill installed to" clj-init-dir)
               ;; Install lisa-loop skill
               lisa-loop-dir (str (fs/path skills-base "lisa-loop"))
               lisa-loop-source (str (fs/path forj-path "packages" "forj-skill" "lisa-loop"))]
           (fs/create-dirs lisa-loop-dir)
           (fs/copy (str (fs/path lisa-loop-source "SKILL.md"))
                    (str (fs/path lisa-loop-dir "SKILL.md")) {:replace-existing true})
           (println "✓ /lisa-loop skill installed to" lisa-loop-dir))}

  uninstall
  {:doc "Remove forj from Claude Code config"
   :task (let [claude-dir (str (fs/path (System/getProperty "user.home") ".claude"))
               mcp-file (str (fs/path claude-dir "mcp.json"))
               settings-file (str (fs/path claude-dir "settings.json"))
               clj-repl-dir (str (fs/path claude-dir "skills" "clj-repl"))
               clj-init-dir (str (fs/path claude-dir "skills" "clj-init"))
               lisa-loop-dir (str (fs/path claude-dir "skills" "lisa-loop"))]
           ;; Remove from MCP config
           (when (fs/exists? mcp-file)
             (let [config (json/parse-string (slurp mcp-file) true)
                   new-config (update config :mcpServers dissoc :forj)]
               (spit mcp-file (json/generate-string new-config {:pretty true}))
               (println "✓ Removed forj from" mcp-file)))
           ;; Remove hooks
           (when (fs/exists? settings-file)
             (let [config (json/parse-string (slurp settings-file) true)
                   new-config (update config :hooks dissoc :SessionStart :UserPromptSubmit :PreToolUse :Stop)]
               (spit settings-file (json/generate-string new-config {:pretty true}))
               (println "✓ Removed hooks from" settings-file)))
           ;; Remove skills
           (when (fs/exists? clj-repl-dir)
             (fs/delete-tree clj-repl-dir)
             (println "✓ Removed /clj-repl skill"))
           (when (fs/exists? clj-init-dir)
             (fs/delete-tree clj-init-dir)
             (println "✓ Removed /clj-init skill"))
           (when (fs/exists? lisa-loop-dir)
             (fs/delete-tree lisa-loop-dir)
             (println "✓ Removed /lisa-loop skill"))
           (println "\n✓ forj uninstalled. Restart Claude Code to complete."))}}}
